<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO ë¶„ì„ ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input[type="url"]:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        
        .radio-option:hover {
            border-color: #0066cc;
            background: #f8f9fa;
        }
        
        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            border-color: #0066cc;
            background: #f0f7ff;
        }
        
        .radio-content {
            flex: 1;
        }
        
        .radio-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .radio-desc {
            font-size: 14px;
            color: #666;
        }
        
        button {
            background: #0066cc;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        button:hover {
            background: #0052a3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #results {
            margin-top: 30px;
        }
        
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .score-value {
            font-size: 64px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score-label {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .grade {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .category-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .category-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
        }
        
        .category-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .category-score {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .broken-link {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .broken-link-url {
            font-weight: 600;
            color: #d32f2f;
            margin-bottom: 8px;
            word-break: break-all;
        }
        
        .broken-link-detail {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        
        .broken-link-detail strong {
            color: #333;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ SEO ë¶„ì„ ë„êµ¬</h1>
        <p class="subtitle">ì›¹ì‚¬ì´íŠ¸ì˜ SEO ì ìˆ˜ë¥¼ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤</p>
        
        <form id="seoForm" method="POST">
            <div class="form-group">
                <label>ëŒ€ìƒ ì›¹ì‚¬ì´íŠ¸ (ë¹ ë¥¸ ì„ íƒ)</label>
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="quickSelect" value="https://mosoft.ca">
                        mosoft.ca
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="quickSelect" value="https://cowaycanada.ca">
                        cowaycanada.ca
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="quickSelect" value="https://davidreno.ca">
                        davidreno.ca
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="url">ì›¹ì‚¬ì´íŠ¸ URL (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìœ„ì—ì„œ ì„ íƒ)</label>
                <input type="url" id="url" name="url" placeholder="https://example.com" required>
            </div>
            
            <div class="form-group">
                <label>ë¶„ì„ ìœ í˜• ì„ íƒ</label>
                
                <label class="radio-option">
                    <input type="radio" name="analysisType" value="quick" checked>
                    <div class="radio-content">
                        <div class="radio-title">âš¡ ë¹ ë¥¸ ë¶„ì„ (3-5ì´ˆ)</div>
                        <div class="radio-desc">ë©”ì¸ í˜ì´ì§€ë§Œ ê°„ë‹¨íˆ ì²´í¬ (PageSpeed ì œì™¸)</div>
                    </div>
                </label>
                
                <label class="radio-option">
                    <input type="radio" name="analysisType" value="standard">
                    <div class="radio-content">
                        <div class="radio-title">ğŸ“Š í‘œì¤€ ë¶„ì„ (30-60ì´ˆ)</div>
                        <div class="radio-desc">ë©”ì¸ í˜ì´ì§€ + í˜ì´ì§€ ì†ë„ ì¸¡ì •</div>
                    </div>
                </label>
                
                <label class="radio-option">
                    <input type="radio" name="analysisType" value="full">
                    <div class="radio-content">
                        <div class="radio-title">ğŸ” ì „ì²´ ì‚¬ì´íŠ¸ ë¶„ì„ (1-2ë¶„)</div>
                        <div class="radio-desc">ì „ì²´ í˜ì´ì§€ ë¶„ì„ + ê¹¨ì§„ ë§í¬ ì°¾ê¸° (PageSpeed ì œì™¸)</div>
                    </div>
                </label>
                
                <label class="radio-option">
                    <input type="radio" name="analysisType" value="complete">
                    <div class="radio-content">
                        <div class="radio-title">ğŸš€ ì™„ì „ ë¶„ì„ (1-2ë¶„)</div>
                        <div class="radio-desc">ì „ì²´ ì‚¬ì´íŠ¸ + í˜ì´ì§€ ì†ë„(ë©”ì¸ë§Œ) + ê¹¨ì§„ ë§í¬</div>
                    </div>
                </label>
                
                <label class="radio-option" style="border-color: #ff9800;">
                    <input type="radio" name="analysisType" value="ultra">
                    <div class="radio-content">
                        <div class="radio-title">ğŸ”¥ ìŠˆí¼ ì™„ì „ ë¶„ì„ (10-20ë¶„) âš ï¸</div>
                        <div class="radio-desc">ì „ì²´ ì‚¬ì´íŠ¸ + ëª¨ë“  í˜ì´ì§€ ì†ë„ ì¸¡ì • + ê¹¨ì§„ ë§í¬ (ë§¤ìš° ëŠë¦¼)</div>
                    </div>
                </label>
            </div>
            
            <button type="submit">ë¶„ì„ ì‹œì‘</button>
        </form>
        
        <div style="margin-top: 20px; padding: 15px; background: #f0f7ff; border-radius: 4px;">
            <strong>ğŸ“š ì°¸ê³ ìë£Œ:</strong>
            <a href="SCORING_CRITERIA.html" target="_blank" style="margin: 0 10px; color: #0066cc;">í˜„ì¬ í‰ê°€ ê¸°ì¤€</a>
            <a href="ROADMAP.html" target="_blank" style="color: #0066cc;">ì¶”í›„ ê°œì„  ê³„íš</a>
        </div>
        
        <div id="loading"></div>
        <div id="downloadSection" style="display: none; margin: 20px 0; text-align: center;">
            <button id="downloadExcel" style="background: #28a745; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
                ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (XLSX)
            </button>
        </div>
        <div id="results"></div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ ë¶„ì„ ê²°ê³¼ ì €ì¥
        let analysisData = null;
        let analysisUrl = '';
        
        // ì•ˆì „í•œ í…ìŠ¤íŠ¸ ë””ì½”ë”© í•¨ìˆ˜
        function safeDecodeText(text) {
            if (!text) return '';
            try {
                // ì´ë¯¸ ì •ìƒì ì¸ UTF-8ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
                return text;
            } catch (e) {
                return text;
            }
        }
        
        // ëŒ€ìƒ ì›¹ì‚¬ì´íŠ¸ ë¹ ë¥¸ ì„ íƒ
        document.querySelectorAll('input[name="quickSelect"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('url').value = e.target.value;
            });
        });
        
        document.getElementById('seoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const url = formData.get('url');
            const analysisType = formData.get('analysisType');
            
            // ë¡œë”© ë©”ì‹œì§€
            let loadingMessage = '';
            if (analysisType === 'quick') {
                loadingMessage = 'ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (3-5ì´ˆ ì†Œìš”)';
            } else if (analysisType === 'standard') {
                loadingMessage = 'í˜ì´ì§€ ì†ë„ ì¸¡ì • ì¤‘... (30-60ì´ˆ ì†Œìš”)';
            } else if (analysisType === 'full') {
                loadingMessage = 'ì „ì²´ ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘... (1-2ë¶„ ì†Œìš”)';
            } else if (analysisType === 'complete') {
                loadingMessage = 'ì „ì²´ ì‚¬ì´íŠ¸ ë¶„ì„ ì¤‘... (1-2ë¶„ ì†Œìš”)';
            } else if (analysisType === 'ultra') {
                loadingMessage = 'ëª¨ë“  í˜ì´ì§€ ì†ë„ ì¸¡ì • ì¤‘... (10-20ë¶„ ì†Œìš”)';
            }
            
            // ìŠˆí¼ ì™„ì „ ë¶„ì„ ê²½ê³ 
            if (analysisType === 'ultra') {
                const confirmResult = confirm(
                    'âš ï¸ ìŠˆí¼ ì™„ì „ ë¶„ì„ì€ 10-20ë¶„ ì´ìƒ ì†Œìš”ë©ë‹ˆë‹¤.\n' +
                    'í˜ì´ì§€ê°€ ë§ì„ìˆ˜ë¡ ì‹œê°„ì´ ë” ê±¸ë¦½ë‹ˆë‹¤.\n\n' +
                    'ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
                );
                if (!confirmResult) return;
            }
            
            document.getElementById('loading').innerHTML = `
                <div class="spinner"></div>
                <p>${loadingMessage}</p>
            `;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.querySelector('button[type="submit"]').disabled = true;
            
            try {
                // PHP ë°±ì—”ë“œë¡œ ì „ì†¡
                const response = await fetch('seo-api.php', {
                    method: 'POST',
                    body: formData
                });
                
                // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € í™•ì¸
                const responseText = await response.text();
                console.log('Raw Response:', responseText);
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + response.status);
                }
                
                // ë¹ˆ ì‘ë‹µ ì²´í¬
                if (!responseText || responseText.trim() === '') {
                    throw new Error('ì„œë²„ì—ì„œ ë¹ˆ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // JSON íŒŒì‹±
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON Parse Error:', e);
                    console.error('Response Text:', responseText);
                    throw new Error('ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: ' + responseText.substring(0, 100));
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // ë¶„ì„ ê²°ê³¼ ì €ì¥
                analysisData = data;
                analysisUrl = url;
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('downloadSection').style.display = 'block';
                
                displayResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('downloadSection').style.display = 'none';
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-error">
                        <strong>ì˜¤ë¥˜:</strong> ${error.message}
                    </div>
                `;
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('button[type="submit"]').disabled = false;
            }
        });
        
        function displayResults(data) {
            const isFullSite = data.page_count !== undefined;
            const scores = isFullSite ? data.average_scores : data.scores;
            const totalScore = scores.total;
            
            let grade = '';
            if (totalScore >= 90) grade = 'ğŸ† Excellent';
            else if (totalScore >= 80) grade = 'âœ… Good';
            else if (totalScore >= 70) grade = 'âš ï¸ Fair';
            else if (totalScore >= 60) grade = 'ğŸ˜ Poor';
            else grade = 'âŒ Very Poor';
            
            let html = `
                <div class="score-card">
                    <div class="score-label">${isFullSite ? 'í‰ê·  SEO ì ìˆ˜' : 'SEO ì ìˆ˜'}</div>
                    <div class="score-value">${totalScore.toFixed(1)}</div>
                    <div class="grade">${grade}</div>
                    ${isFullSite ? `<p style="margin-top: 15px; opacity: 0.9;">ì´ ${data.page_count}ê°œ í˜ì´ì§€ ë¶„ì„</p>` : ''}
                </div>
                
                <div class="section">
                    <div class="section-title">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜</div>
                    <div class="category-scores">
                        <div class="category-item">
                            <div class="category-name">ğŸŒ Local SEO (30% ê°€ì¤‘ì¹˜)</div>
                            <div class="category-score">${Math.round(scores.local_seo)} / 100</div>
                        </div>
                        <div class="category-item">
                            <div class="category-name">âš™ï¸ Technical (20% ê°€ì¤‘ì¹˜)</div>
                            <div class="category-score">${Math.round(scores.technical)} / 100</div>
                        </div>
                        <div class="category-item">
                            <div class="category-name">ğŸ“„ On-Page (20% ê°€ì¤‘ì¹˜)</div>
                            <div class="category-score">${Math.round(scores.onpage)} / 100</div>
                        </div>
                        ${scores.mobile > 0 ? `
                        <div class="category-item">
                            <div class="category-name">ğŸ“± Mobile (15% ê°€ì¤‘ì¹˜)</div>
                            <div class="category-score">${Math.round(scores.mobile)} / 100</div>
                        </div>
                        ` : ''}
                        <div class="category-item">
                            <div class="category-name">ğŸ“ Content (15% ê°€ì¤‘ì¹˜)</div>
                            <div class="category-score">${Math.round(scores.content)} / 100</div>
                        </div>
                    </div>
                    ${scores.mobile === 0 ? '<p style="color: #666; font-size: 14px; margin-top: 10px;">* Mobile ì ìˆ˜ëŠ” PageSpeed ì¸¡ì •ì´ í¬í•¨ëœ ë¶„ì„ì—ì„œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>' : ''}
                </div>
            `;
            
            // ê¹¨ì§„ ë§í¬
            if (isFullSite && data.broken_links && data.broken_links.length > 0) {
                const realBroken = data.broken_links.filter(bl => !bl.url.includes('cdn-cgi'));
                
                if (realBroken.length > 0) {
                    html += `<div class="section"><div class="section-title">ğŸ”´ ê¹¨ì§„ ë§í¬ (${realBroken.length}ê°œ)</div>`;
                    
                    realBroken.forEach((bl, index) => {
                        const linkText = safeDecodeText(bl.link_text);
                        
                        html += `
                            <div class="broken-link">
                                <div class="broken-link-url">${index + 1}. ${bl.url}</div>
                                <div class="broken-link-detail"><strong>ğŸ“„ ë°œê²¬ í˜ì´ì§€:</strong> ${bl.found_on}</div>
                                ${linkText ? `<div class="broken-link-detail"><strong>ğŸ“ ë§í¬ í…ìŠ¤íŠ¸:</strong> "${linkText}"</div>` : ''}
                                ${bl.original_href ? `<div class="broken-link-detail"><strong>ğŸ”— ì›ë³¸ href:</strong> ${bl.original_href}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            }
            
            // í˜ì´ì§€ë³„ ìƒì„¸ ì ìˆ˜ (ì „ì²´ ì‚¬ì´íŠ¸ ë¶„ì„)
            if (isFullSite && data.page_scores && data.page_scores.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">ğŸ“„ í˜ì´ì§€ë³„ ìƒì„¸ ì ìˆ˜ (${data.page_scores.length}ê°œ)</div>
                `;
                
                data.page_scores.forEach((page, index) => {
                    const scoreColor = page.scores.total >= 80 ? '#28a745' : page.scores.total >= 70 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <div style="background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid ${scoreColor}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 5px;">í˜ì´ì§€ ${index + 1}</div>
                                    <a href="${page.url}" target="_blank" style="color: #0066cc; word-break: break-all; font-size: 14px;">${page.url}</a>
                                </div>
                                <span style="font-size: 32px; font-weight: bold; color: ${scoreColor}; margin-left: 15px;">${Math.round(page.scores.total)}</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #667eea;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ğŸŒ Local SEO</div>
                                    <div style="font-size: 20px; font-weight: bold;">${Math.round(page.scores.local_seo)}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #f093fb;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">âš™ï¸ Technical</div>
                                    <div style="font-size: 20px; font-weight: bold;">${Math.round(page.scores.technical)}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #4facfe;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ğŸ“„ On-Page</div>
                                    <div style="font-size: 20px; font-weight: bold;">${Math.round(page.scores.onpage)}</div>
                                </div>
                                ${page.scores.mobile > 0 ? `
                                <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #43e97b;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ğŸ“± Mobile</div>
                                    <div style="font-size: 20px; font-weight: bold;">${Math.round(page.scores.mobile)}</div>
                                </div>
                                ` : ''}
                                <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #fa709a;">
                                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ğŸ“ Content</div>
                                    <div style="font-size: 20px; font-weight: bold;">${Math.round(page.scores.content)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            document.getElementById('results').innerHTML = html;
        }
        
        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        document.getElementById('downloadExcel').addEventListener('click', () => {
            if (!analysisData) {
                alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const isFullSite = analysisData.page_count !== undefined;
            const wb = XLSX.utils.book_new();
            
            // 1. ìš”ì•½ ì‹œíŠ¸
            const summaryData = [];
            summaryData.push(['SEO ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸']);
            summaryData.push(['ë¶„ì„ ì¼ì‹œ', new Date().toLocaleString('ko-KR')]);
            summaryData.push(['ë¶„ì„ URL', analysisUrl]);
            summaryData.push(['ë¶„ì„ ìœ í˜•', isFullSite ? 'ì „ì²´ ì‚¬ì´íŠ¸' : 'ë‹¨ì¼ í˜ì´ì§€']);
            if (isFullSite) {
                summaryData.push(['ë¶„ì„ í˜ì´ì§€ ìˆ˜', analysisData.page_count + 'ê°œ']);
            }
            summaryData.push([]);
            
            const scores = isFullSite ? analysisData.average_scores : analysisData.scores;
            summaryData.push(['ì¹´í…Œê³ ë¦¬', 'ì ìˆ˜ (0-100)', 'ê°€ì¤‘ì¹˜']);
            summaryData.push(['ì´ì ', Math.round(scores.total), '100%']);
            summaryData.push(['Local SEO', Math.round(scores.local_seo), '30%']);
            summaryData.push(['Technical', Math.round(scores.technical), '20%']);
            summaryData.push(['On-Page', Math.round(scores.onpage), '20%']);
            if (scores.mobile > 0) {
                summaryData.push(['Mobile', Math.round(scores.mobile), '15%']);
            }
            summaryData.push(['Content', Math.round(scores.content), '15%']);
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{wch: 20}, {wch: 15}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, ws1, 'ìš”ì•½');
            
            // 2. í˜ì´ì§€ë³„ ì ìˆ˜ (ì „ì²´ ì‚¬ì´íŠ¸ ë¶„ì„ì¸ ê²½ìš°)
            if (isFullSite && analysisData.page_scores && analysisData.page_scores.length > 0) {
                const pageData = [];
                pageData.push(['í˜ì´ì§€ URL', 'ì´ì ', 'Local SEO', 'Technical', 'On-Page', 'Mobile', 'Content']);
                
                analysisData.page_scores.forEach(page => {
                    pageData.push([
                        page.url,
                        Math.round(page.scores.total),
                        Math.round(page.scores.local_seo),
                        Math.round(page.scores.technical),
                        Math.round(page.scores.onpage),
                        Math.round(page.scores.mobile),
                        Math.round(page.scores.content)
                    ]);
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(pageData);
                ws2['!cols'] = [{wch: 50}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 10}, {wch: 12}];
                XLSX.utils.book_append_sheet(wb, ws2, 'í˜ì´ì§€ë³„ ì ìˆ˜');
            }
            
            // 3. ê¹¨ì§„ ë§í¬ (ìˆëŠ” ê²½ìš°)
            if (isFullSite && analysisData.broken_links && analysisData.broken_links.length > 0) {
                const realBroken = analysisData.broken_links.filter(bl => !bl.url.includes('cdn-cgi'));
                
                if (realBroken.length > 0) {
                    const brokenData = [];
                    brokenData.push(['ê¹¨ì§„ ë§í¬ URL', 'ë°œê²¬ í˜ì´ì§€', 'ë§í¬ í…ìŠ¤íŠ¸', 'ì›ë³¸ href']);
                    
                    realBroken.forEach(bl => {
                        brokenData.push([
                            bl.url,
                            bl.found_on,
                            safeDecodeText(bl.link_text) || '',
                            bl.original_href || ''
                        ]);
                    });
                    
                    const ws3 = XLSX.utils.aoa_to_sheet(brokenData);
                    ws3['!cols'] = [{wch: 50}, {wch: 50}, {wch: 30}, {wch: 30}];
                    XLSX.utils.book_append_sheet(wb, ws3, 'ê¹¨ì§„ ë§í¬');
                }
            }
            
            // 4. ê°œì„  ê¶Œì¥ì‚¬í•­ (ìˆëŠ” ê²½ìš°)
            if (analysisData.recommendations && analysisData.recommendations.length > 0) {
                const recData = [];
                recData.push(['ì¹´í…Œê³ ë¦¬', 'ìš°ì„ ìˆœìœ„', 'ë¬¸ì œ', 'ë©”ì‹œì§€', 'í˜„ì¬ ìƒíƒœ', 'ê¶Œì¥ì‚¬í•­']);
                
                analysisData.recommendations.forEach(rec => {
                    recData.push([
                        rec.category,
                        rec.priority,
                        rec.issue,
                        rec.message,
                        rec.current || '',
                        rec.recommendation || ''
                    ]);
                });
                
                const ws4 = XLSX.utils.aoa_to_sheet(recData);
                ws4['!cols'] = [{wch: 15}, {wch: 12}, {wch: 20}, {wch: 40}, {wch: 30}, {wch: 40}];
                XLSX.utils.book_append_sheet(wb, ws4, 'ê°œì„  ê¶Œì¥ì‚¬í•­');
            }
            
            // íŒŒì¼ëª… ìƒì„±
            const domain = new URL(analysisUrl).hostname;
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `SEOë¶„ì„_${domain}_${timestamp}.xlsx`;
            
            // ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, filename);
        });
    </script>
</body>
</html>